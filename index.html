<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D3PIA: A Discrete Denoising Diffusion Model for Piano Accompaniment Generation</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { margin:0; padding:0; background:#f8fbf4; font-family:'Inter', sans-serif; color:#333; }
    .container { max-width:960px; margin:0 auto; padding:40px 20px; text-align:center; }
    h1 { font-size:32px; color:#3e5e30; margin-bottom:16px; }
    p { font-size:16px; color:#555; line-height:1.6; margin-bottom:32px; }
    section { background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(169,209,152,.2); padding:30px; margin-top:30px; }
    h2 { color:#4a7c59; font-size:22px; margin-bottom:16px; }
    h3 { font-size:18px; color:#3e5e30; margin:20px 0 8px; }
    select { padding:10px 16px; font-size:16px; border:2px solid #a9d198; border-radius:6px; background:#fff; cursor:pointer; transition:border-color .3s; }
    select:hover { border-color:#77ab59; }
    button { background:#d8e8d0; color:#3e5e30; border:none; padding:10px 18px; margin:6px; border-radius:6px; cursor:pointer; font-size:14px; transition:background-color .3s, transform .2s; }
    button:hover { background:#a9d198; transform:translateY(-1px); }
    button.active, button.dataset-active { background: #63974d; color: #fff; }
    button.ours { background:#7fb1e3; color:#fff; }
    button.ours:hover { background:#4a90e2; }
    button.ours.active, button.ours.dataset-active { background:#3b6b9d; }
    button.leadsheet { background:#f8d4a5; color:#8b5000; }
    button.leadsheet:hover { background:#f0ad4e; color:#fff; }
    button.leadsheet.active, button.leadsheet.dataset-active { background:#d58512; color:#fff; }
    button.dataset-active { background:#8bc275; color:#fff; }

    #midiVisualizer { display:none; width:100%; max-width:800px; height:344px; margin:30px auto 10px; border:2px solid #a9d198; border-radius:10px; background:#fff; }
    #loadingMessage { font-size:18px; color:#666; margin:20px 0; }
    midi-visualizer .piano-roll-visualizer { border:none; overflow:auto; text-align:left; }
    midi-visualizer svg rect.note { opacity:.9; }
    midi-visualizer svg rect.note[data-instrument="0"],
    midi-visualizer svg rect.note[data-instrument="1"] { fill:#a9d198; }
    midi-visualizer svg rect.note[data-is-drum="true"] { fill:#77ab59; }
    midi-visualizer svg rect.note.active { fill:#4a7c59; opacity:1; }
    midi-visualizer .piano-roll-visualizer svg { background:linear-gradient(90deg,#ccc 1px,transparent 1px 25px, rgba(169,209,152,.7) 26px, transparent 26px 50px, rgba(169,209,152,.7) 51px, transparent 51px 75px, rgba(169,209,152,.7) 76px, transparent 76px) left/100px repeat; margin:0; display:inline-block; }
    midi-player { display:block; margin:10px auto 0; width:100%; max-width:800px; }
    midi-player::part(seek-bar){ accent-color:#4a7c59; }

    .toggle-container { margin-top:15px; text-align:center; }
    #toggleModelInfo { background:#4a7c59; color:#fff; font-size:13px; }
    #toggleModelInfo:hover { background:#3e5e30; }

    /* #modelInfoContainer { display:none; margin:20px auto; padding:15px; background:#f1f8ec; border:1px solid #a9d198; border-radius:8px; max-width:800px; text-align:left; } */
    .model-info { display:none; margin-bottom:10px; }
    .model-info h4 { color:#4a7c59; margin-bottom:5px; }
    .model-info p { font-size:14px; margin-top:0; color:#444; }

    /* NEW: per-model scores panel */
    #scoresContainer { display:none; margin:14px auto 0; max-width:800px; }
    .scores-card { background:#ffffff; border:1px solid #a9d198; border-radius:8px; padding:12px; box-shadow:0 2px 10px rgba(169,209,152,.18); }
    .scores-card h4 { margin:0 0 8px; color:#3e5e30; }
    .scores-table { width:100%; border-collapse:collapse; }
    .scores-table thead th { font-weight:600; font-size:13px; color:#4a7c59; border-bottom:2px solid #a9d198; padding:8px; text-align:center; }
    .scores-table tbody td { padding:8px; border-bottom:1px solid #e1f0da; font-size:14px; }
    .scores-table tbody tr.highlight { background:#f7fff1; font-weight:600; }
    /* .score-badge { display:inline-block; min-width:36px; padding:2px 8px; border-radius:12px; background:#f1f8ec; border:1px solid #a9d198; text-align:center; } */
  
    
    /* Í∑∏Î£π Ìó§Îçî(Í∞ùÍ¥Ä/Ï£ºÍ¥Ä) Ìñâ Ïä§ÌÉÄÏùº */
    .scores-table thead tr.group th {
      text-align:center;
      font-weight:600;
      /* font-size:12px; */
      border-bottom:1px solid #a9d198;
      padding:6px 8px;
    }

    /* ÏÑ∏Î°ú Íµ¨Î∂ÑÏÑ†: 2Ïó¥(Chord Accuracy)Í≥º 4Ïó¥(Harmony) ÏïûÏóê ÎùºÏù∏ */
    .scores-table thead th.split,
    .scores-table tbody td.split {
      border-left:2px solid #a9d198;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"></script>
</head>
<body>
  <div class="container">
    <h1>D3PIA: A Discrete Denoising Diffusion Model for Piano Accompaniment Generation from Lead Sheet</h1>
    <h2>Submitted to ICASSP 2026</h2>
    <p>We propose a discrete diffusion-based piano accompaniment generation model, <b>D3PIA</b>, leveraging the locally aligned structure of musical accompaniments with the lead sheet in the piano roll representation.</p>

    <section id="listening_test">
      <div>
        <h3>üéµ Select a Sample</h3>
        <select id="sampleSelect" onchange="updateSample()">
          <option value="058__seg_48_56">058__seg_48_56</option>
          <option value="163__seg_48_56">163__seg_48_56</option>
          <option value="190__seg_32_40">190__seg_32_40</option>
          <option value="445__seg_16_24">445__seg_16_24</option>
          <option value="449__seg_8_16">449__seg_8_16</option>
          <option value="492__seg_8_16">492__seg_8_16</option>
          <option value="551__seg_32_40">551__seg_32_40</option>
          <option value="573__seg_56_64">573__seg_56_64</option>
          <option value="656__seg_48_56">656__seg_48_56</option>
          <option value="692__seg_56_64" selected>692__seg_56_64</option>
        </select>
      </div>

      <div>
        <h3>ü§ñ Choose a Model</h3>
        <button onclick="playMidi('d3rm', this)" class="active ours">D3PIA (ours)</button>
        <button onclick="playMidi('test', this)">GT</button>
        <button onclick="playMidi('polyffusion', this)">Polyffusion</button>
        <button onclick="playMidi('cne_no_velocity', this)">C&E-E</button>
        <button onclick="playMidi('wholesonggen', this)">WSG-4th</button>
        <button onclick="playMidi('efficient_diffusion', this)">FGG</button>
        <button onclick="playMidi('leadsheet', this)" class="leadsheet">Leadsheet (input)</button>
      </div>

      <div id="loadingMessage">Loading...</div>
      <midi-visualizer id="midiVisualizer" src="demo_src/subjective_eval_samples/692__seg_56_64/d3rm.mid"></midi-visualizer>
      <midi-player id="midiPlayer" src="demo_src/subjective_eval_samples/692__seg_56_64/d3rm.mid" sound-font visualizer="#listening_test midi-visualizer"></midi-player>

      <div class="toggle-container">
        <button id="toggleModelInfo" onclick="toggleModelInfo()">Show/Hide Model Info & Scores</button>
      </div>

      <div id="modelInfoContainer">
        <div id="d3rm-info" class="model-info"><h4>D3PIA</h4><p>Trained with 8 bars. Temperature = 1.5</p></div>
        <div id="test-info" class="model-info"><h4>GT</h4><p>Test split of POP909 Dataset including melody, bridge, and arrangement track</p></div>
        <div id="polyffusion-info" class="model-info"><h4>Polyffusion</h4><p>Trained with 8 bars. Generated with inpainting "below" option. chord CFG cond_scale = 5.0</p></div>
        <div id="cne_no_velocity-info" class="model-info"><h4>C&E-E</h4><p>Re-implemented (GPT-2) embellish part. Temp = 1.1, p = 0.95</p></div>
        <div id="wholesonggen-info" class="model-info"><h4>WSG-4th</h4><p>Stage 4 model of WholeSongGen.</p></div>
        <div id="efficient_diffusion-info" class="model-info"><h4>FGG</h4><p>Trained with 8 bars (4 bars in original code).</p></div>
        <div id="leadsheet-info" class="model-info"><h4>Leadsheet</h4><p>Melody and chord. Segments selected when melody exists in ‚â•4 bars.</p></div>
      </div>

      <!-- NEW: Scores Panel (per-model Harmony/Correctness for the selected sample) -->
      <div id="scoresContainer">
        <div class="scores-card">
          <h4 id="scoresTitle">Scores</h4>
          <table class="scores-table">
            <thead>
              <tr class="group">
                <th></th>
                <th colspan="2">Objective Metrics</th>
                <th colspan="2">Subjective Metrics</th>
              </tr>
              <tr>
                <th>Model</th>
                <th class="split">Chord Accuracy</th>
                <th>Chord Similarity</th>
                <th class="split">Harmony</th>
                <th>Correctness</th>
              </tr>
            </thead>
            
            <tbody id="scoresBody"></tbody>
          </table>
        </div>
      </div>

    </section>
  </div>

  <script>
    let midiTempo = 120;
    let currentModel = 'd3rm';

    // === NEW: CSV paths (adjust if you host elsewhere) ===
    const CHORD_ACC_CSV_URL = 'demo_src/subjective_eval_tables/chord_accuracy_pivot.csv';
    const CHORD_SIM_CSV_URL = 'demo_src/subjective_eval_tables/chord_similarity_pivot.csv';
    const HARMONY_CSV_URL = 'demo_src/subjective_eval_tables/harmony_pivot.csv';
    const CORRECTNESS_CSV_URL = 'demo_src/subjective_eval_tables/correctness_pivot.csv';

    // Map UI model keys -> CSV column headers
    const modelToColumn = {
      'd3rm': 'd3rm.wav',
      'test': 'test.wav',
      'polyffusion': 'polyffusion.wav',
      'cne_no_velocity': 'cne_no_velocity.wav',
      'wholesonggen': 'wholesonggen.wav',
      'efficient_diffusion': 'efficient_diffusion.wav',
      'leadsheet': null // not rated
    };

    const modelLabel = {
      'd3rm': 'D3PIA (ours)',
      'test': 'GT',
      'polyffusion': 'Polyffusion',
      'cne_no_velocity': 'C&E-E',
      'wholesonggen': 'WSG-4th',
      'efficient_diffusion': 'FGG',
      'leadsheet': 'Leadsheet (input)'
    };

    // Data holders after CSV load
    let chordAccPivot = {};
    let chordSimPivot = {};
    let harmonyPivot = {};      // { sample_id: {colName: value, ...}, ... }
    let correctnessPivot = {};  // same shape as harmonyPivot

    function fetchTempo(sampleName) {
      return fetch('demo_src/tempos.json')
        .then(r => r.json())
        .then(data => {
          const baseSampleName = sampleName.split('__')[0];
          const tempoKey = `${baseSampleName}.mid`;
          midiTempo = data[tempoKey] || midiTempo;
        });
    }

    function calculatePixelsPerTimeStep(bpm) {
      const totalBeats = 4 * 8; // 8 bars in 4/4
      const durationInSeconds = totalBeats / (bpm / 60);
      return 800 / durationInSeconds;
    }

    function setupVisualizer() {
      const midiVisualizer = document.getElementById('midiVisualizer');
      if (midiVisualizer._visualizer) {
        try {
          midiVisualizer.removeChild(midiVisualizer._visualizer);
          midiVisualizer._visualizer = null;
        } catch (e) { console.log('viz reset err:', e); }
      }
      midiVisualizer.config = { noteHeight:4, pixelsPerTimeStep: calculatePixelsPerTimeStep(midiTempo), minPitch:22, maxPitch:108 };
      midiVisualizer.style.display = 'block';
      document.getElementById('loadingMessage').style.display = 'none';
      setTimeout(() => {
        const pianoRoll = midiVisualizer.shadowRoot?.querySelector('.piano-roll-visualizer');
        if (pianoRoll) {
          pianoRoll.style.textAlign = 'left';
          const svg = pianoRoll.querySelector('svg');
          if (svg) { svg.style.margin='0'; svg.style.display='inline-block'; svg.style.position='relative'; svg.style.left='0'; }
        }
      }, 100);
    }

    function initializeVisualizer(sampleName) { fetchTempo(sampleName).then(setupVisualizer); }

    document.getElementById('midiVisualizer').onloadeddata = () => {
      const sampleName = document.getElementById('sampleSelect').value; initializeVisualizer(sampleName);
    };

    function updateSample() {
      const sampleName = document.getElementById('sampleSelect').value;
      const midiPlayer = document.getElementById('midiPlayer');
      const midiVisualizer = document.getElementById('midiVisualizer');
      midiPlayer.src = `demo_src/subjective_eval_samples/${sampleName}/d3rm.mid`;
      midiVisualizer.src = `demo_src/subjective_eval_samples/${sampleName}/d3rm.mid`;
      initializeVisualizer(sampleName);
      document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
      document.querySelector('button[onclick*="d3rm"]').classList.add('active');
      currentModel = 'd3rm';
      updateModelInfo();
      renderScoresPanel(); // NEW: refresh scores for newly selected sample
    }

    window.onload = () => {
      const defaultSample = document.getElementById('sampleSelect').value;
      initializeVisualizer(defaultSample);
      // Load CSVs then make first render
      Promise.all([loadPivotCSV(CHORD_ACC_CSV_URL, chordAccPivot), loadPivotCSV(CHORD_SIM_CSV_URL, chordSimPivot), loadPivotCSV(HARMONY_CSV_URL, harmonyPivot), loadPivotCSV(CORRECTNESS_CSV_URL, correctnessPivot)])
        .then(() => { renderScoresPanel(); })
        .catch(err => console.error('CSV load error', err));
    };

    function playMidi(modelName, button) {
      const sampleName = document.getElementById('sampleSelect').value;
      const midiPlayer = document.getElementById('midiPlayer');
      const midiVisualizer = document.getElementById('midiVisualizer');
      midiPlayer.src = `demo_src/subjective_eval_samples/${sampleName}/${modelName}.mid`;
      midiVisualizer.src = `demo_src/subjective_eval_samples/${sampleName}/${modelName}.mid`;
      midiPlayer.onloadeddata = () => midiPlayer.play().catch(console.error);
      midiVisualizer.onloadeddata = () => midiVisualizer.play?.();
      document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      currentModel = modelName;
      updateModelInfo();
      highlightCurrentModelRow(); // NEW: highlight row in scores table
    }

    function toggleModelInfo() {
      const info = document.getElementById('modelInfoContainer');
      const scores = document.getElementById('scoresContainer');
      const isOpen = info.style.display === 'block';
      if (isOpen) {
        info.style.display = 'none';
        scores.style.display = 'none';
      } else {
        info.style.display = 'block';
        scores.style.display = 'block';
        updateModelInfo();
        renderScoresPanel();
      }
    }

    function updateModelInfo() {
      document.querySelectorAll('.model-info').forEach(info => info.style.display = 'none');
      const selectedInfo = document.getElementById(`${currentModel}-info`);
      if (selectedInfo) selectedInfo.style.display = 'block';
    }

    // ===== NEW: CSV handling and scores rendering =====
    function loadPivotCSV(url, targetObj) {
      return fetch(url).then(r => r.text()).then(text => {
        const { header, rows } = simpleCSVParse(text);
        // First column is index (sample_id); rest are model columns
        const idxName = header[0];
        rows.forEach(rw => {
          const rowObj = {}; for (let i = 1; i < header.length; i++) { const key = header[i]; const val = rw[i]; rowObj[key] = toNumOrNull(val); }
          const idx = rw[0];
          targetObj[idx] = rowObj;
        });
      });
    }

    function simpleCSVParse(text) {
      // very light CSV parser (assumes no embedded commas or quotes in fields)
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(',').map(s => s.trim());
      const rows = lines.slice(1).map(line => line.split(',').map(s => s.trim()));
      return { header, rows };
    }

    function toNumOrNull(v){ if (v === undefined || v === null || v === '') return null; const n = Number(v); return isNaN(n) ? null : n; }

    function renderScoresPanel() {
      const scoresDiv = document.getElementById('scoresContainer');
      if (!scoresDiv) return;
      const sampleName = document.getElementById('sampleSelect').value;
      const title = document.getElementById('scoresTitle');
      title.textContent = `Scores : ${sampleName}`;
      const tbody = document.getElementById('scoresBody');
      tbody.innerHTML = '';

      const modelsOrder = ['d3rm','test','polyffusion','cne_no_velocity','wholesonggen','efficient_diffusion'];
      modelsOrder.forEach(m => {
        const col = modelToColumn[m];
        if (!col) return; // skip leadsheet
        const acc = chordAccPivot?.[sampleName]?.[col];
        const sim = chordSimPivot?.[sampleName]?.[col];
        const harm = harmonyPivot?.[sampleName]?.[col];
        const corr = correctnessPivot?.[sampleName]?.[col];
        const tr = document.createElement('tr');
        tr.dataset.model = m;
        if (m === currentModel) tr.classList.add('highlight');
        const nameTd = document.createElement('td'); nameTd.textContent = modelLabel[m];
        const aTd = document.createElement('td'); aTd.innerHTML = acc==null? '‚Äî' : `<span class="score-badge">${Number(acc).toFixed(1)}</span>`; 
        aTd.classList.add('split');                   // ‚Üê ÏÑ∏Î°ú Íµ¨Î∂ÑÏÑ†
        const sTd = document.createElement('td'); sTd.innerHTML = sim==null? '‚Äî' : `<span class="score-badge">${Number(sim).toFixed(1)}</span>`;
        const hTd = document.createElement('td'); hTd.innerHTML = harm==null? '‚Äî' : `<span class="score-badge">${Number(harm).toFixed(1)}</span>`;
        hTd.classList.add('split');                   // ‚Üê ÏÑ∏Î°ú Íµ¨Î∂ÑÏÑ†

        const cTd = document.createElement('td'); cTd.innerHTML = corr==null? '‚Äî' : `<span class="score-badge">${Number(corr).toFixed(1)}</span>`;
        tr.appendChild(nameTd); tr.appendChild(aTd); tr.appendChild(sTd); tr.appendChild(hTd); tr.appendChild(cTd); tbody.appendChild(tr);
      });
    }

    function highlightCurrentModelRow(){
      document.querySelectorAll('#scoresBody tr').forEach(tr => tr.classList.remove('highlight'));
      const row = document.querySelector(`#scoresBody tr[data-model="${currentModel}"]`);
      if (row) row.classList.add('highlight');
    }
  </script>
</body>
</html>
